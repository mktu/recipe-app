# ADR-001: 食材マッチングの表記揺れ対応

## ステータス

実装済み

## 日付

2026-02-16

## コンテキスト

レシピ登録時・検索時に、抽出した食材名をマスター食材にマッチングする必要がある。
現状は完全一致/部分一致/エイリアス検索で対応しているが、表記揺れに対応できていない。

### 発生している問題

| 入力 | 期待するマッチ | 現状 | 原因 |
|------|---------------|------|------|
| 長ネギ | 長ねぎ / ねぎ | マッチしない | カタカナ/ひらがな |
| 豚バラ薄切り肉 | 豚バラ肉 | マッチしない | 調理法が含まれる |
| ニンジン | にんじん | マッチしない | カタカナ/ひらがな |

### 影響を受けるフロー

1. **登録フロー**: URL → 食材名抽出 → マスター食材IDに変換
2. **検索フロー**: テキスト入力（例: "豚肉 玉ねぎ"）→ マスター食材IDに変換

## 検討した選択肢

### 選択肢1: 正規化の強化（カタカナ→ひらがな変換、調理法除去）

```
「長ネギ」→ ひらがな変換 →「長ねぎ」→ マッチ
「豚バラ薄切り肉」→ 調理法除去 →「豚バラ肉」→ マッチ
```

**却下理由**:
- DBをどちらの表記で統一するか問題（マスターはひらがな？カタカナ？）
- 調理法で区別したいケースがある（薄切り vs 細切れ）
- ルールベースの対応は網羅が難しい

### 選択肢2: ベクトル埋め込みで食材マッチング

```
食材マスターに name_embedding を追加
抽出した食材名を埋め込み → ベクトル類似度で最も近いマスター食材を選択
```

**却下理由**:
- 登録時に毎回Embedding API呼び出しが必要
- ユーザー数がスケールするとレート制限の問題
- 類似食材（豚バラ vs 豚こま）の区別が難しい
- タイトル検索と違い、食材マッチングは厳密さが求められる

### 選択肢3: エイリアステーブル自動拡充（採用）

```
【登録時（リアルタイム）】
  従来通りの完全一致/部分一致/エイリアス検索
  → 未マッチは unmatched_ingredients に記録（現状通り）

【バッチ処理（1日1回）】
  未マッチ食材 → LLMで一括判定 → エイリアス自動登録
```

## 決定

**選択肢3: エイリアステーブル自動拡充** を採用する。

### 処理フロー

```
1. unmatched_ingredients から未処理を取得（出現頻度順）
2. 上位100件を処理対象
3. LLM（Gemini）に一括で問い合わせ（1回のAPI呼び出し）
   - マッチ → ingredient_aliases に登録（auto_generated = true）
   - 新規 → ingredients に追加（needs_review = true）
4. 処理済みを unmatched_ingredients から削除
```

### 設定値

| 項目 | 値 |
|------|-----|
| バッチ頻度 | 1日1回 |
| 処理上限 | 100件/日 |
| マッチしない場合 | 新規食材として追加（要レビュー） |

## 理由

1. **リアルタイム処理が軽量**: 登録時はDB検索のみでAPI呼び出し不要
2. **厳密なマッチングを維持**: LLMが「豚バラ肉」と「豚こま肉」を明確に区別
3. **スケーラブル**: ユーザー数が増えてもリアルタイム処理に影響なし
4. **継続的に改善**: 使われるほどエイリアスが蓄積され精度向上
5. **コスト予測可能**: 1日100件上限でAPI費用を管理
6. **フィードバックループ**: エイリアス登録 = 学習完了、次回から自動マッチ

## 実装内容

### DBスキーマ変更

```sql
-- ingredient_aliases に追加
ALTER TABLE ingredient_aliases
ADD COLUMN auto_generated BOOLEAN DEFAULT FALSE,
ADD COLUMN created_at TIMESTAMPTZ DEFAULT NOW();

-- 未マッチ食材の出現頻度取得用RPC
CREATE FUNCTION get_unmatched_ingredient_counts(limit_count INTEGER)
RETURNS TABLE (normalized_name TEXT, count BIGINT);
```

### ファイル構成

```
supabase/migrations/
  20260216000000_alias_auto_generate.sql  # マイグレーション

src/lib/batch/
  alias-generator.ts   # コアロジック（Node.js用）

scripts/
  auto-alias.ts        # ローカル実行用スクリプト

supabase/functions/
  auto-alias/
    index.ts           # Edge Function（本番用）
```

### 使い方

```bash
# ローカルでテスト実行
npx tsx scripts/auto-alias.ts

# ドライラン（実際には登録しない）
npx tsx scripts/auto-alias.ts --dry-run

# 処理件数を指定
npx tsx scripts/auto-alias.ts --limit=10
```

## トレードオフ

- 初回登録時は未マッチのまま（翌日以降のバッチで補完）
- 新しい表記揺れには即座に対応できない（最大1日の遅延）

## 将来の拡張

- 手動でエイリアス追加するUIの提供
- 未マッチ頻度が高い食材のアラート通知
- pg_cron でEdge Functionを定期実行（本番環境）
