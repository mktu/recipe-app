# Scripts

é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆé›†

## ãƒ¬ã‚·ãƒ”ç™»éŒ²ãƒ†ã‚¹ãƒˆ

### URLåé›†

```bash
npm run collect:urls
```

ã‚µã‚¤ãƒˆãƒãƒƒãƒ—ã‹ã‚‰è‡ªå‹•ã§ãƒ¬ã‚·ãƒ”URLã‚’åé›†ã—ã€`seed/test-recipe-urls.txt` ã«ä¿å­˜ã™ã‚‹ã€‚

**åé›†å¯¾è±¡ã‚µã‚¤ãƒˆ:**
- Delish Kitchen (50ä»¶)
- ã‚¯ãƒ©ã‚·ãƒ« (50ä»¶)
- ã¿ã‚“ãªã®ãã‚‡ã†ã®æ–™ç† (15ä»¶)
- å‘³ã®ç´ ãƒ‘ãƒ¼ã‚¯ (13ä»¶)
- ç™½ã”ã¯ã‚“.com (10ä»¶)

### ãƒ¬ã‚·ãƒ”ç™»éŒ²ãƒ†ã‚¹ãƒˆ

```bash
# å…¨ä»¶å®Ÿè¡Œ
npm run test:recipe

# ä»¶æ•°åˆ¶é™
npm run test:recipe --limit=10

# ãƒ‘ãƒ¼ã‚¹ã®ã¿ï¼ˆç™»éŒ²ã—ãªã„ï¼‰
npm run test:recipe --dry-run

# å˜ç™ºå®Ÿè¡Œ
npm run test:recipe https://example.com/recipe/123

# ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ã‚’èª¿æ•´ï¼ˆãƒŸãƒªç§’ï¼‰
npm run test:recipe --delay=2000
```

**å‰ææ¡ä»¶:**
- é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ (`npm run dev`)
- ãƒ­ãƒ¼ã‚«ãƒ« Supabase ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ (`supabase start`)

**å‡ºåŠ›ä¾‹:**
```
ğŸ§ª ãƒ¬ã‚·ãƒ”ç™»éŒ²ä¸€æ‹¬ãƒ†ã‚¹ãƒˆ
========================
ã‚µãƒ¼ãƒãƒ¼: http://localhost:3000
ãƒ¦ãƒ¼ã‚¶ãƒ¼: dev-user-001
å¯¾è±¡ä»¶æ•°: 10ä»¶

[1/10] https://delishkitchen.tv/recipes/xxx
   ãƒ‘ãƒ¼ã‚¹ä¸­...
   ã‚¿ã‚¤ãƒˆãƒ«: ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ã‚·ãƒ”
   é£Ÿææ•°: 5ä»¶
   ç™»éŒ²ä¸­...
   âœ… ç™»éŒ²å®Œäº† (ID: xxx)

========================================
ğŸ“Š å®Ÿè¡Œçµæœãƒ¬ãƒãƒ¼ãƒˆ
========================================
âœ… æˆåŠŸ: 8ä»¶
â­ï¸  ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç™»éŒ²æ¸ˆã¿ï¼‰: 2ä»¶
âŒ å¤±æ•—: 0ä»¶
åˆè¨ˆ: 10ä»¶
```

## LINE Botãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

```bash
# é£Ÿææ¤œç´¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
npm run test:bot "é£Ÿæ"

# é€šå¸¸æ¤œç´¢
npm run test:bot "é¶è‚‰ ç‰ã­ã"

# ãƒ˜ãƒ«ãƒ—
npm run test:bot "ä½¿ã„æ–¹"
```

LINE Botã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¢ºèªã§ãã‚‹ã€‚ngrokä¸è¦ã€‚

**å‰ææ¡ä»¶:**
- ãƒ­ãƒ¼ã‚«ãƒ« Supabase ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ (`supabase start`)

**å‡ºåŠ›ä¾‹:**
```
ğŸ§ª LINE Bot Response Test
========================================
ğŸ“¤ Input: "é£Ÿæ"
ğŸ‘¤ User: dev-user-001

ğŸ”€ Route: Ingredient Search Prompt

ğŸ“¥ Response:
   type: text
   text: ğŸ” é£Ÿæã§æ¤œç´¢
         ...

   quickReply:
     - [é¶è‚‰] â†’ "é¶è‚‰"
     - [è±šè‚‰] â†’ "è±šè‚‰"
     ...
```

## åŸ‹ã‚è¾¼ã¿ç”Ÿæˆï¼ˆãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ç”¨ï¼‰

ãƒ¬ã‚·ãƒ”ç™»éŒ²æ™‚ã¯ `title_embedding = NULL` ã§ä¿å­˜ã•ã‚Œã€ãƒãƒƒãƒå‡¦ç†ã§åŸ‹ã‚è¾¼ã¿ã‚’ç”Ÿæˆã™ã‚‹ã€‚

### ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ

**æ–¹æ³•1: ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ¨å¥¨ï¼‰**

```bash
# ãƒ¬ã‚·ãƒ”ç™»éŒ² + åŸ‹ã‚è¾¼ã¿ç”Ÿæˆã‚’ã‚»ãƒƒãƒˆã§å®Ÿè¡Œ
npm run test:recipe:with-embeddings -- --limit=5

# åŸ‹ã‚è¾¼ã¿ã®ã¿ç”Ÿæˆï¼ˆæ—¢å­˜ãƒ¬ã‚·ãƒ”å¯¾è±¡ï¼‰
npm run backfill:embeddings
```

**æ–¹æ³•2: Edge Function ã‚’ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ**

```bash
# 1. Edge Function ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
npm run functions:serve

# 2. Edge Function ã‚’å‘¼ã³å‡ºã—
npm run functions:invoke
```

**å‡ºåŠ›ä¾‹:**
```json
{"message":"Embedding generation completed","processed":3,"succeeded":3,"failed":0}
```

### ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°/æœ¬ç•ªç’°å¢ƒ

```bash
# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã®ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«
npm run backfill:embeddings -- --env=staging
```

æœ¬ç•ªã§ã¯ pg_cron + Edge Function ã§5åˆ†æ¯ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

### ãƒªãƒˆãƒ©ã‚¤åˆ¶é™

- åŸ‹ã‚è¾¼ã¿ç”Ÿæˆã«å¤±æ•—ã—ãŸãƒ¬ã‚·ãƒ”ã¯ `embedding_retry_count` ãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹
- 3å›å¤±æ•—ã™ã‚‹ã¨å‡¦ç†å¯¾è±¡ã‹ã‚‰é™¤å¤–ã•ã‚Œã‚‹
- ãƒªã‚»ãƒƒãƒˆ: `UPDATE recipes SET embedding_retry_count = 0 WHERE ...`

## é£Ÿæãƒãƒƒãƒãƒ³ã‚°è§£æ

```bash
./scripts/check-ingredient-match-rate.sh
```

DBã«ç™»éŒ²ã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ã®é£Ÿæãƒãƒƒãƒãƒ³ã‚°ç‡ã¨æœªãƒãƒƒãƒé£ŸæTOP20ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
